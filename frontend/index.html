<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­¦å¯è§†åŒ–ç”Ÿæˆå™¨ - å¤šæ¨¡å‹å¹¶è¡Œå¤„ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 30px;
            margin: 0;
            font-size: 28px;
            font-weight: 700;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
        }

        .input-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            min-height: 600px;
        }

        .model-result-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .model-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .model-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
        }

        .model-status {
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-waiting {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .status-processing {
            background-color: #fff3cd;
            color: #856404;
            animation: pulse 2s infinite;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .model-progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e9ecef;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }

        .model-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .model-result-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .model-image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border-radius: 8px;
            min-height: 200px;
            border: 2px dashed #dee2e6;
        }

        .model-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .model-analysis {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #3498db;
        }

        .model-analysis h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 600;
        }

        .model-analysis-content {
            font-size: 13px;
            line-height: 1.5;
            color: #495057;
            max-height: 120px;
            overflow-y: auto;
        }

        .model-timing {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
            margin-top: 5px;
        }

        .image-placeholder {
            color: #6c757d;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 120px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .select, .textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .select:focus, .textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .prompt-info-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .prompt-section {
            margin-bottom: 20px;
        }

        .prompt-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .prompt-content {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .prompt-stats {
            color: #6c757d;
            font-size: 12px;
            margin-top: 5px;
        }

        .model-token-info {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 10px;
            font-size: 12px;
        }

        .token-stat {
            display: inline-block;
            margin-right: 15px;
            color: #495057;
        }

        .token-stat strong {
            color: #2c3e50;
        }

        .toggle-prompt-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: background-color 0.3s;
        }

        .toggle-prompt-btn:hover {
            background: #495057;
        }

        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(4, 1fr);
            }
            
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ æ•°å­¦å¯è§†åŒ–ç”Ÿæˆå™¨ - å¤šæ¨¡å‹å¹¶è¡Œå¤„ç†</h1>
        
        <div class="main-container">
            <div class="input-panel">
                <form id="problemForm" class="form">
                    <div class="form-group">
                        <label for="testCaseSelect">ğŸ“ é€‰æ‹©æµ‹è¯•é¢˜ç›®:</label>
                        <select id="testCaseSelect" class="select">
                            <option value="">-- è¯·é€‰æ‹©æµ‹è¯•é¢˜ç›® --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="problemText">ğŸ¤” æ•°å­¦é—®é¢˜æè¿°:</label>
                        <textarea id="problemText" rows="5" class="textarea" 
                                placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¦å¯è§†åŒ–çš„æ•°å­¦æ¦‚å¿µæˆ–é—®é¢˜..." required></textarea>
                    </div>
                    
                    <button type="submit" class="btn" id="submitBtn">
                        ğŸš€ åŒæ—¶å¤„ç†æ‰€æœ‰æ¨¡å‹
                    </button>
                    
                    <div class="button-group" style="margin-top: 10px;">
                        <button type="button" id="togglePromptBtn" onclick="togglePromptInfo()" class="toggle-btn">
                            ğŸ“ æ˜¾ç¤º/éšè— Promptä¿¡æ¯
                        </button>
                    </div>
                </form>
                
                <div id="globalStatus" class="status">
                    <div id="globalStatusText">å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…ä»»åŠ¡æäº¤...
                    </div>
                    <div class="progress-bar">
                        <div id="globalProgressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Prompt Information Panel -->
            <div class="prompt-info-panel" id="promptInfoPanel">
                <div class="prompt-section">
                    <h3>ğŸ“ System Prompt <span class="prompt-stats" id="systemPromptStats">é•¿åº¦: -- å­—ç¬¦</span></h3>
                    <div class="prompt-content" id="systemPromptContent">ç­‰å¾…ä»»åŠ¡æäº¤...</div>
                </div>
                <div class="prompt-section">
                    <h3>ğŸ’¬ User Prompt <span class="prompt-stats" id="userPromptStats">é•¿åº¦: -- å­—ç¬¦</span></h3>
                    <div class="prompt-content" id="userPromptContent">ç­‰å¾…ä»»åŠ¡æäº¤...</div>
                </div>
            </div>

            <div class="results-grid">
                <div class="model-result-panel" id="openaiPanel">
                    <div class="model-header">
                        <div class="model-name">ğŸ¤– OpenAI / Moonshot</div>
                        <div class="model-status status-waiting" id="openaiStatus">ç­‰å¾…ä¸­</div>
                    </div>
                    <div class="model-progress-bar">
                        <div class="model-progress-fill" id="openaiProgress" style="width: 0%"></div>
                    </div>
                    <div class="model-result-content">
                        <div class="model-image-container">
                            <img id="openaiImage" class="model-image" src="" alt="OpenAIç”Ÿæˆçš„å›¾è¡¨" style="display: none;">
                            <div id="openaiImagePlaceholder" class="image-placeholder">ç­‰å¾…å›¾è¡¨ç”Ÿæˆ...</div>
                        </div>
                        <div class="model-analysis">
                            <h4>ğŸ“Š åˆ†æç»“æœ</h4>
                            <div id="openaiAnalysis" class="model-analysis-content">ç­‰å¾…åˆ†æ...</div>
                        </div>
                        <div class="model-token-info">
                            <div class="token-label">ğŸ”¢ Tokenä½¿ç”¨:</div>
                            <div id="openaiTokens" class="token-details">ç­‰å¾…ä¸­...</div>
                        </div>
                        <div id="openaiTiming" class="model-timing">è€—æ—¶: --</div>
                    </div>
                </div>

                <div class="model-result-panel" id="claudePanel">
                    <div class="model-header">
                        <div class="model-name">ğŸ§  Claude / Moonshot</div>
                        <div class="model-status status-waiting" id="claudeStatus">ç­‰å¾…ä¸­</div>
                    </div>
                    <div class="model-progress-bar">
                        <div class="model-progress-fill" id="claudeProgress" style="width: 0%"></div>
                    </div>
                    <div class="model-result-content">
                        <div class="model-image-container">
                            <img id="claudeImage" class="model-image" src="" alt="Claudeç”Ÿæˆçš„å›¾è¡¨" style="display: none;">
                            <div id="claudeImagePlaceholder" class="image-placeholder">ç­‰å¾…å›¾è¡¨ç”Ÿæˆ...</div>
                        </div>
                        <div class="model-analysis">
                            <h4>ğŸ“Š åˆ†æç»“æœ</h4>
                            <div id="claudeAnalysis" class="model-analysis-content">ç­‰å¾…åˆ†æ...</div>
                        </div>
                        <div class="model-token-info">
                            <div class="token-label">ğŸ”¢ Tokenä½¿ç”¨:</div>
                            <div id="claudeTokens" class="token-details">ç­‰å¾…ä¸­...</div>
                        </div>
                        <div id="claudeTiming" class="model-timing">è€—æ—¶: --</div>
                    </div>
                </div>

                <div class="model-result-panel" id="qwenPanel">
                    <div class="model-header">
                        <div class="model-name">ğŸ”® Qwen</div>
                        <div class="model-status status-waiting" id="qwenStatus">ç­‰å¾…ä¸­</div>
                    </div>
                    <div class="model-progress-bar">
                        <div class="model-progress-fill" id="qwenProgress" style="width: 0%"></div>
                    </div>
                    <div class="model-result-content">
                        <div class="model-image-container">
                            <img id="qwenImage" class="model-image" src="" alt="Qwenç”Ÿæˆçš„å›¾è¡¨" style="display: none;">
                            <div id="qwenImagePlaceholder" class="image-placeholder">ç­‰å¾…å›¾è¡¨ç”Ÿæˆ...</div>
                        </div>
                        <div class="model-analysis">
                            <h4>ğŸ“Š åˆ†æç»“æœ</h4>
                            <div id="qwenAnalysis" class="model-analysis-content">ç­‰å¾…åˆ†æ...</div>
                        </div>
                        <div class="model-token-info">
                            <div class="token-label">ğŸ”¢ Tokenä½¿ç”¨:</div>
                            <div id="qwenTokens" class="token-details">ç­‰å¾…ä¸­...</div>
                        </div>
                        <div id="qwenTiming" class="model-timing">è€—æ—¶: --</div>
                    </div>
                </div>

                <div class="model-result-panel" id="deepseekPanel">
                    <div class="model-header">
                        <div class="model-name">ğŸš€ DeepSeek</div>
                        <div class="model-status status-waiting" id="deepseekStatus">ç­‰å¾…ä¸­</div>
                    </div>
                    <div class="model-progress-bar">
                        <div class="model-progress-fill" id="deepseekProgress" style="width: 0%"></div>
                    </div>
                    <div class="model-result-content">
                        <div class="model-image-container">
                            <img id="deepseekImage" class="model-image" src="" alt="DeepSeekç”Ÿæˆçš„å›¾è¡¨" style="display: none;">
                            <div id="deepseekImagePlaceholder" class="image-placeholder">ç­‰å¾…å›¾è¡¨ç”Ÿæˆ...</div>
                        </div>
                        <div class="model-analysis">
                            <h4>ğŸ“Š åˆ†æç»“æœ</h4>
                            <div id="deepseekAnalysis" class="model-analysis-content">ç­‰å¾…åˆ†æ...</div>
                        </div>
                        <div class="model-token-info">
                            <div class="token-label">ğŸ”¢ Tokenä½¿ç”¨:</div>
                            <div id="deepseekTokens" class="token-details">ç­‰å¾…ä¸­...</div>
                        </div>
                        <div id="deepseekTiming" class="model-timing">è€—æ—¶: --</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_V2 = 'http://localhost:8001/api/v2';
        
        // 4ä¸ªæ¨¡å‹é…ç½®
        const MODEL_CONFIGS = {
            'openai': {
                name: 'OpenAI / Moonshot',
                emoji: 'ğŸ¤–',
                provider: 'openai'
            },
            'claude': {
                name: 'Claude / Moonshot',
                emoji: 'ğŸ§ ',
                provider: 'claude'
            },
            'qwen': {
                name: 'Qwen',
                emoji: 'ğŸ”®',
                provider: 'qwen'
            },
            'deepseek': {
                name: 'DeepSeek',
                emoji: 'ğŸš€',
                provider: 'deepseek'
            }
        };

        let testCases = [];
        let currentTasks = {}; // å­˜å‚¨4ä¸ªæ¨¡å‹çš„ä»»åŠ¡IDå’ŒçŠ¶æ€
        let modelTimers = {}; // æ¯ä¸ªæ¨¡å‹çš„è®¡æ—¶å™¨
        let taskStartTimes = {}; // ä»»åŠ¡å¼€å§‹æ—¶é—´

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–å¤šæ¨¡å‹å¹¶è¡Œå¤„ç†ç•Œé¢...');
            initializeEventListeners();
            loadTestCases();
        });

        // åŠ è½½æµ‹è¯•ç”¨ä¾‹
        async function loadTestCases() {
            try {
                console.log('å¼€å§‹åŠ è½½æµ‹è¯•ç”¨ä¾‹...');
                const response = await fetch('/math_test_case.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                console.log('æµ‹è¯•ç”¨ä¾‹JSONåŸå§‹æ–‡æœ¬:', text);
                
                testCases = JSON.parse(text);
                console.log('è§£ææµ‹è¯•ç”¨ä¾‹æˆåŠŸ:', testCases);
                
                populateTestCaseSelect();
            } catch (error) {
                console.error('åŠ è½½æµ‹è¯•ç”¨ä¾‹å¤±è´¥:', error);
                showGlobalStatus(`åŠ è½½æµ‹è¯•ç”¨ä¾‹å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¡«å……æµ‹è¯•ç”¨ä¾‹é€‰æ‹©æ¡†
        function populateTestCaseSelect() {
            const select = document.getElementById('testCaseSelect');
            testCases.forEach(testCase => {
                const option = document.createElement('option');
                option.value = testCase.id;
                option.textContent = testCase.title || `æµ‹è¯•ç”¨ä¾‹ ${testCase.id}`;
                select.appendChild(option);
            });
            console.log('æµ‹è¯•ç”¨ä¾‹é€‰æ‹©æ¡†å¡«å……å®Œæˆ');
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            console.log('å¼€å§‹åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨...');
            
            // æµ‹è¯•ç”¨ä¾‹é€‰æ‹©å˜åŒ– - è‡ªåŠ¨å¡«å……åˆ°è¾“å…¥æ¡†
            document.getElementById('testCaseSelect').addEventListener('change', function() {
                const selectedId = this.value;
                if (selectedId) {
                    const testCase = testCases.find(tc => tc.id === selectedId);
                    if (testCase) {
                        document.getElementById('problemText').value = testCase.original_text;
                        console.log('è‡ªåŠ¨åŠ è½½äº†æµ‹è¯•ç”¨ä¾‹:', selectedId);
                    }
                } else {
                    document.getElementById('problemText').value = '';
                }
            });
            
            // è¡¨å•æäº¤ - å¹¶è¡Œå¤„ç†æ‰€æœ‰æ¨¡å‹
            document.getElementById('problemForm').addEventListener('submit', handleMultiModelSubmit);
            
            console.log('äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ');
        }

        // å¤„ç†å¤šæ¨¡å‹å¹¶è¡Œæäº¤
        async function handleMultiModelSubmit(event) {
            event.preventDefault();
            
            console.log('=== å¼€å§‹è¡¨å•æäº¤å¤„ç† ===');
            
            const problemText = document.getElementById('problemText').value.trim();
            console.log('é—®é¢˜æ–‡æœ¬:', problemText);
            
            if (!problemText) {
                alert('è¯·è¾“å…¥æ•°å­¦é—®é¢˜æè¿°');
                return;
            }

            console.log('å¼€å§‹å¤šæ¨¡å‹å¹¶è¡Œå¤„ç†:', problemText);
            
            try {
                // ç¦ç”¨æäº¤æŒ‰é’®
                document.getElementById('submitBtn').disabled = true;
                
                // é‡ç½®æ‰€æœ‰æ¨¡å‹çš„çŠ¶æ€
                resetAllModels();
                
                // æ˜¾ç¤ºå…¨å±€çŠ¶æ€
                showGlobalStatus('æ­£åœ¨å¯åŠ¨æ‰€æœ‰æ¨¡å‹...', 'processing', 0);
                
                console.log('å‡†å¤‡å¯åŠ¨æ¨¡å‹...');
                
                // å¹¶è¡Œå¯åŠ¨æ‰€æœ‰4ä¸ªæ¨¡å‹
                const providers = Object.keys(MODEL_CONFIGS);
                console.log('æä¾›å•†åˆ—è¡¨:', providers);
                
                const promises = providers.map(provider => {
                    console.log(`å‡†å¤‡æäº¤åˆ° ${provider}`);
                    return submitToModel(provider, problemText);
                });
                
                // ç­‰å¾…æ‰€æœ‰æ¨¡å‹å¯åŠ¨ï¼ˆä¸ç­‰å¾…å®Œæˆï¼‰
                const results = await Promise.allSettled(promises);
                console.log('æ‰€æœ‰æ¨¡å‹å¯åŠ¨ç»“æœ:', results);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥çš„å¯åŠ¨
                const failures = results.filter(result => result.status === 'rejected');
                if (failures.length > 0) {
                    console.error('éƒ¨åˆ†æ¨¡å‹å¯åŠ¨å¤±è´¥:', failures);
                    showGlobalStatus(`éƒ¨åˆ†æ¨¡å‹å¯åŠ¨å¤±è´¥ (${failures.length}/${providers.length})`, 'warning', 25);
                } else {
                    console.log('æ‰€æœ‰æ¨¡å‹å·²å¯åŠ¨');
                    showGlobalStatus('æ‰€æœ‰æ¨¡å‹å·²å¯åŠ¨ï¼Œæ­£åœ¨å¹¶è¡Œå¤„ç†...', 'processing', 25);
                }
            } catch (error) {
                console.error('å¯åŠ¨æ¨¡å‹æ—¶å‡ºé”™:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                showGlobalStatus(`å¯åŠ¨æ¨¡å‹å¤±è´¥: ${error.message}`, 'error');
            } finally {
                // é‡æ–°å¯ç”¨æäº¤æŒ‰é’®
                document.getElementById('submitBtn').disabled = false;
                console.log('=== è¡¨å•æäº¤å¤„ç†å®Œæˆ ===');
            }
        }

        // é‡ç½®æ‰€æœ‰æ¨¡å‹çŠ¶æ€
        function resetAllModels() {
            const providers = Object.keys(MODEL_CONFIGS);
            providers.forEach(provider => {
                // é‡ç½®çŠ¶æ€
                updateModelStatus(provider, 'å‡†å¤‡ä¸­', 'processing');
                updateModelProgress(provider, 0);
                
                // æ¸…ç©ºå†…å®¹
                const imageElement = document.getElementById(`${provider}Image`);
                const placeholderElement = document.getElementById(`${provider}ImagePlaceholder`);
                const analysisElement = document.getElementById(`${provider}Analysis`);
                const timingElement = document.getElementById(`${provider}Timing`);
                
                imageElement.style.display = 'none';
                imageElement.src = '';
                placeholderElement.style.display = 'flex';
                placeholderElement.textContent = 'ç­‰å¾…å›¾è¡¨ç”Ÿæˆ...';
                analysisElement.textContent = 'ç­‰å¾…åˆ†æ...';
                timingElement.textContent = 'è€—æ—¶: --';
                
                // æ¸…é™¤å®šæ—¶å™¨
                if (modelTimers[provider]) {
                    clearInterval(modelTimers[provider]);
                    delete modelTimers[provider];
                }
            });
            
            // é‡ç½®å…¨å±€çŠ¶æ€
            currentTasks = {};
            taskStartTimes = {};
        }

        // æäº¤åˆ°å•ä¸ªæ¨¡å‹
        async function submitToModel(provider, problemText) {
            try {
                console.log(`=== å¼€å§‹æäº¤åˆ° ${provider} æ¨¡å‹ ===`);
                console.log(`é—®é¢˜æ–‡æœ¬:`, problemText);
                console.log(`APIåœ°å€:`, API_BASE_V2);
                
                updateModelStatus(provider, 'æäº¤ä¸­', 'processing');
                updateModelProgress(provider, 10);
                
                const requestData = {
                    text: problemText,
                    user_id: 'demo_user',
                    llm_provider: provider,
                    processing_mode: 'ai',
                    prompt_variant: 'default'
                };
                
                console.log(`${provider} è¯·æ±‚æ•°æ®:`, requestData);
                
                const response = await fetch(`${API_BASE_V2}/problems/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log(`${provider} å“åº”çŠ¶æ€:`, response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const taskId = data.task_id;
                
                console.log(`${provider} ä»»åŠ¡å·²æäº¤ï¼Œä»»åŠ¡ID:`, taskId);
                
                // å­˜å‚¨ä»»åŠ¡ä¿¡æ¯
                currentTasks[provider] = taskId;
                taskStartTimes[provider] = Date.now();
                
                updateModelStatus(provider, 'å¤„ç†ä¸­', 'processing');
                updateModelProgress(provider, 20);
                
                // å¯åŠ¨çŠ¶æ€è½®è¯¢
                startModelStatusPolling(provider, taskId);
                
            } catch (error) {
                console.error(`${provider} æ¨¡å‹æäº¤å¤±è´¥:`, error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                updateModelStatus(provider, `æäº¤å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // å¼€å§‹è½®è¯¢æ¨¡å‹çŠ¶æ€
        function startModelStatusPolling(provider, taskId) {
            if (modelTimers[provider]) {
                clearInterval(modelTimers[provider]);
            }
            
            modelTimers[provider] = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE_V2}/tasks/${taskId}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log(`${provider} çŠ¶æ€æ›´æ–°:`, data);
                    
                    // æ›´æ–°è€—æ—¶æ˜¾ç¤º
                    const elapsed = Math.round((Date.now() - taskStartTimes[provider]) / 1000);
                    document.getElementById(`${provider}Timing`).textContent = `è€—æ—¶: ${elapsed}s`;
                    
                    // æ ¹æ®çŠ¶æ€æ›´æ–°è¿›åº¦å’Œæ˜¾ç¤º
                    if (data.status === 'completed') {
                        clearInterval(modelTimers[provider]);
                        delete modelTimers[provider];
                        await handleModelCompletion(provider, data);
                        checkAllModelsCompletion();
                    } else if (data.status === 'failed') {
                        clearInterval(modelTimers[provider]);
                        delete modelTimers[provider];
                        updateModelStatus(provider, 'å¤„ç†å¤±è´¥', 'error');
                        checkAllModelsCompletion();
                    } else if (data.status === 'processing') {
                        updateModelStatus(provider, 'ç”Ÿæˆä¸­', 'processing');
                        updateModelProgress(provider, Math.min(80, 20 + elapsed * 2));
                    }
                    
                } catch (error) {
                    console.error(`${provider} çŠ¶æ€æŸ¥è¯¢å¤±è´¥:`, error);
                }
            }, 2000);
        }

        // å¤„ç†æ¨¡å‹å®Œæˆ
        async function handleModelCompletion(provider, data) {
            console.log(`${provider} å¤„ç†å®Œæˆ:`, data);
            
            // è°ƒè¯•æ—¥å¿—
            if (data.ai_analysis) {
                console.log(`${provider} AIåˆ†ææ•°æ®:`, data.ai_analysis);
                if (data.ai_analysis.llm_interaction) {
                    console.log(`${provider} LLMäº¤äº’æ•°æ®:`, data.ai_analysis.llm_interaction);
                    if (data.ai_analysis.llm_interaction.usage_stats) {
                        console.log(`${provider} Tokenä½¿ç”¨ç»Ÿè®¡:`, data.ai_analysis.llm_interaction.usage_stats);
                    }
                }
            }
            
            updateModelStatus(provider, 'å®Œæˆ', 'completed');
            updateModelProgress(provider, 100);
            
            // æ˜¾ç¤ºç»“æœå›¾ç‰‡
            if (data.execution_result && data.execution_result.image_path) {
                const imageElement = document.getElementById(`${provider}Image`);
                const placeholderElement = document.getElementById(`${provider}ImagePlaceholder`);
                
                // ä»è·¯å¾„ä¸­æå–æ–‡ä»¶åï¼Œä¾‹å¦‚ "output/abc123.png" -> "abc123.png"
                const imagePath = data.execution_result.image_path;
                const filename = imagePath.split('/').pop(); // è·å–æ–‡ä»¶åéƒ¨åˆ†
                const imageUrl = `${API_BASE_V2}/images/${filename}`;
                console.log(`${provider} å›¾ç‰‡URL:`, imageUrl);
                
                imageElement.src = imageUrl;
                imageElement.style.display = 'block';
                placeholderElement.style.display = 'none';
            }
            
            // æ˜¾ç¤ºåˆ†æç»“æœ
            if (data.ai_analysis && data.ai_analysis.explanation) {
                const analysisElement = document.getElementById(`${provider}Analysis`);
                analysisElement.textContent = data.ai_analysis.explanation;
            }
            
            // æ›´æ–°Tokenä½¿ç”¨ä¿¡æ¯
            if (data.ai_analysis && data.ai_analysis.llm_interaction && data.ai_analysis.llm_interaction.usage_stats) {
                updateTokenInfo(provider, data.ai_analysis.llm_interaction.usage_stats);
            }
            
            // å¯¹äºç¬¬ä¸€ä¸ªå®Œæˆçš„æ¨¡å‹ï¼Œæ˜¾ç¤ºPromptä¿¡æ¯ï¼ˆå› ä¸ºæ‰€æœ‰æ¨¡å‹ä½¿ç”¨ç›¸åŒçš„promptï¼‰
            if (data.ai_analysis && data.ai_analysis.llm_interaction) {
                console.log(`${provider} LLMäº¤äº’æ•°æ®è¯¦æƒ…:`, data.ai_analysis.llm_interaction);
                
                if (data.ai_analysis.llm_interaction.system_prompt) {
                    console.log(`${provider} ç³»ç»ŸPrompt:`, data.ai_analysis.llm_interaction.system_prompt);
                }
                
                if (data.ai_analysis.llm_interaction.user_prompt) {
                    console.log(`${provider} ç”¨æˆ·Prompt:`, data.ai_analysis.llm_interaction.user_prompt);
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºäº†promptä¿¡æ¯
                const systemPromptElement = document.getElementById('systemPromptContent');
                if (!systemPromptElement.textContent || systemPromptElement.textContent === 'ç­‰å¾…ä»»åŠ¡æäº¤...') {
                    console.log(`${provider} æ­£åœ¨æ˜¾ç¤ºPromptä¿¡æ¯...`);
                    updatePromptInfo(
                        data.ai_analysis.llm_interaction.system_prompt, 
                        data.ai_analysis.llm_interaction.user_prompt
                    );
                } else {
                    console.log(`${provider} Promptä¿¡æ¯å·²å­˜åœ¨ï¼Œè·³è¿‡æ˜¾ç¤º`);
                }
            } else {
                console.log(`${provider} ç¼ºå°‘LLMäº¤äº’æ•°æ®:`, data.ai_analysis?.llm_interaction);
            }
        }

        // æ£€æŸ¥æ‰€æœ‰æ¨¡å‹æ˜¯å¦å®Œæˆ
        function checkAllModelsCompletion() {
            const providers = Object.keys(MODEL_CONFIGS);
            const completedCount = providers.filter(provider => {
                const status = document.getElementById(`${provider}Status`).textContent;
                return status === 'å®Œæˆ' || status === 'å¤„ç†å¤±è´¥';
            }).length;
            
            if (completedCount === providers.length) {
                console.log('æ‰€æœ‰æ¨¡å‹å¤„ç†å®Œæˆ');
                showGlobalStatus('æ‰€æœ‰æ¨¡å‹å¤„ç†å®Œæˆï¼', 'completed', 100);
            } else {
                const progress = Math.round((completedCount / providers.length) * 75) + 25;
                showGlobalStatus(`å·²å®Œæˆ ${completedCount}/${providers.length} ä¸ªæ¨¡å‹`, 'processing', progress);
            }
        }

        // æ›´æ–°æ¨¡å‹çŠ¶æ€
        function updateModelStatus(provider, statusText, statusClass) {
            const statusElement = document.getElementById(`${provider}Status`);
            statusElement.textContent = statusText;
            statusElement.className = `model-status status-${statusClass}`;
        }

        // æ›´æ–°æ¨¡å‹è¿›åº¦
        function updateModelProgress(provider, percentage) {
            const progressElement = document.getElementById(`${provider}Progress`);
            progressElement.style.width = `${percentage}%`;
        }

        // æ˜¾ç¤ºå…¨å±€çŠ¶æ€
        function showGlobalStatus(message, type, progress = null) {
            const statusText = document.getElementById('globalStatusText');
            const progressFill = document.getElementById('globalProgressFill');
            
            statusText.textContent = message;
            
            if (progress !== null) {
                progressFill.style.width = `${progress}%`;
            }
            
            console.log('å…¨å±€çŠ¶æ€æ›´æ–°:', message, type, progress);
        }

        // åˆ‡æ¢Promptä¿¡æ¯æ˜¾ç¤º
        function togglePromptInfo() {
            const panel = document.getElementById('promptInfoPanel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // æ›´æ–°Promptä¿¡æ¯æ˜¾ç¤º
        function updatePromptInfo(systemPrompt, userPrompt) {
            console.log('updatePromptInfo è¢«è°ƒç”¨ï¼š', { systemPrompt: systemPrompt?.length, userPrompt: userPrompt?.length });
            
            // æ›´æ–°ç³»ç»ŸPromptå†…å®¹
            const systemPromptElement = document.getElementById('systemPromptContent');
            const systemPromptStatsElement = document.getElementById('systemPromptStats');
            if (systemPromptElement && systemPrompt) {
                systemPromptElement.textContent = systemPrompt;
                systemPromptStatsElement.textContent = `é•¿åº¦: ${systemPrompt.length} å­—ç¬¦`;
                console.log('ç³»ç»ŸPromptå·²æ›´æ–°');
            }
            
            // æ›´æ–°ç”¨æˆ·Promptå†…å®¹
            const userPromptElement = document.getElementById('userPromptContent');
            const userPromptStatsElement = document.getElementById('userPromptStats');
            if (userPromptElement && userPrompt) {
                userPromptElement.textContent = userPrompt;
                userPromptStatsElement.textContent = `é•¿åº¦: ${userPrompt.length} å­—ç¬¦`;
                console.log('ç”¨æˆ·Promptå·²æ›´æ–°');
            }
            
            // æ˜¾ç¤ºToggleæŒ‰é’®
            const toggleBtn = document.getElementById('togglePromptBtn');
            if (toggleBtn) {
                toggleBtn.style.display = 'inline-block';
                console.log('ToggleæŒ‰é’®å·²æ˜¾ç¤º');
            }
            
            // æ˜¾ç¤ºPrompté¢æ¿
            const promptPanel = document.getElementById('promptInfoPanel');
            if (promptPanel) {
                promptPanel.style.display = 'block';
                console.log('Prompté¢æ¿å·²æ˜¾ç¤º');
            }
        }

        // æ›´æ–°å„ä¸ªæ¨¡å‹çš„Tokenä½¿ç”¨ä¿¡æ¯
        function updateTokenInfo(provider, tokenData) {
            const tokenElement = document.getElementById(`${provider}Tokens`);
            if (tokenData && tokenData.input_tokens && tokenData.output_tokens && tokenData.total_tokens) {
                tokenElement.innerHTML = `
                    <div>è¾“å…¥: ${tokenData.input_tokens.toLocaleString()}</div>
                    <div>è¾“å‡º: ${tokenData.output_tokens.toLocaleString()}</div>
                    <div>æ€»è®¡: ${tokenData.total_tokens.toLocaleString()}</div>
                `;
            } else {
                tokenElement.textContent = 'æš‚æ— æ•°æ®';
            }
        }
    </script>
</body>
</html>
