<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­¦å¯è§†åŒ–ç”Ÿæˆå™¨ - å¤šæ¨¡å‹å¹¶è¡Œå¤„ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 30px;
            margin: 0;
            font-size: 28px;
            font-weight: 700;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
        }

        .input-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            min-height: 600px;
        }

        .model-result-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .model-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .model-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
        }

        .model-status {
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-waiting {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .status-processing {
            background-color: #fff3cd;
            color: #856404;
            animation: pulse 2s infinite;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .model-progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e9ecef;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }

        .model-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .model-result-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .model-image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            border-radius: 8px;
            min-height: 200px;
            border: 2px dashed #dee2e6;
        }

        .model-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .model-analysis {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #3498db;
        }

        .model-analysis h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 600;
        }

        .model-analysis-content {
            font-size: 13px;
            line-height: 1.5;
            color: #495057;
            max-height: 120px;
            overflow-y: auto;
        }

        .model-timing {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
            margin-top: 5px;
        }

        .image-placeholder {
            color: #6c757d;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 120px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .select, .textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .select:focus, .textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .prompt-info-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            display: block;
        }

        .prompt-section {
            margin-bottom: 20px;
        }

        .prompt-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .prompt-content {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .prompt-stats {
            color: #6c757d;
            font-size: 12px;
            margin-top: 5px;
        }

        .model-token-info {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 10px;
            font-size: 12px;
        }

        .token-stat {
            display: inline-block;
            margin-right: 15px;
            color: #495057;
        }

        .token-stat strong {
            color: #2c3e50;
        }

        .toggle-prompt-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        /* é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºæ ·å¼ */
        .error-details-container {
            margin-top: 15px;
            border: 1px solid #dc3545;
            border-radius: 8px;
            background: #f8d7da;
            color: #721c24;
        }

        .error-details-header {
            padding: 12px 15px;
            background: #f5c6cb;
            border-bottom: 1px solid #dc3545;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 14px;
        }

        .error-details-header:hover {
            background: #f1b2b7;
        }

        .error-details-content {
            padding: 15px;
            display: none;
        }

        .error-details-content.expanded {
            display: block;
        }

        .error-type-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .error-type-api_error {
            background: #ff6b6b;
            color: white;
        }

        .error-type-json_parse_error {
            background: #ffa500;
            color: white;
        }

        .error-type-validation_error {
            background: #ff9f00;
            color: white;
        }

        .error-type-code_execution_failed {
            background: #e74c3c;
            color: white;
        }

        .error-type-exception {
            background: #8e44ad;
            color: white;
        }

        .error-section {
            margin-bottom: 15px;
        }

        .error-section-title {
            font-weight: 600;
            color: #721c24;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .error-code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border-left: 4px solid #4299e1;
        }

        .error-message-block {
            background: #fff5f5;
            border-left: 4px solid #fc8181;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
        }

        .error-api-response {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .error-validation-list {
            background: #fef5e7;
            border: 1px solid #f6ad55;
            border-radius: 6px;
            padding: 10px;
        }

        .error-validation-list ul {
            margin: 0;
            padding-left: 20px;
        }

        .error-validation-list li {
            margin-bottom: 5px;
            font-size: 12px;
        }

        .error-toggle-options {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #f1f5f9;
            border-radius: 6px;
        }

        .error-toggle-options label {
            font-size: 12px;
            margin-left: 8px;
            cursor: pointer;
        }

        .error-toggle-options input[type="radio"] {
            margin-right: 5px;
        }

        .error-actions {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #dc3545;
            display: flex;
            gap: 10px;
        }

        .error-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 500;
        }

        .error-copy-btn {
            background: #6c757d;
            color: white;
        }

        .error-retry-btn {
            background: #28a745;
            color: white;
        }

        .error-copy-btn:hover {
            background: #5a6268;
        }

        .error-retry-btn:hover {
            background: #218838;
        }

        /* æ›¿æ¢å›¾ç‰‡åŒºåŸŸçš„é”™è¯¯æ˜¾ç¤ºæ ·å¼ */
        .error-image-replacement {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            padding: 20px;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            border: 2px dashed #fc8181;
            border-radius: 8px;
            text-align: center;
        }

        .error-image-replacement.api-error {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            border-color: #fc8181;
        }

        .error-image-replacement.ai-analysis-failed {
            background: linear-gradient(135deg, #fffbeb 0%, #fed7aa 100%);
            border-color: #f6ad55;
        }

        .error-image-replacement.code-execution-failed {
            background: linear-gradient(135deg, #fffff0 0%, #fef5e7 100%);
            border-color: #ecc94b;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        .error-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .error-subtitle {
            font-size: 14px;
            color: #718096;
            margin-bottom: 16px;
            max-width: 300px;
        }

        .error-actions-inline {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .error-action-btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .error-view-btn {
            background: #4299e1;
            color: white;
        }

        .error-view-btn:hover {
            background: #3182ce;
        }

        .error-retry-btn-small {
            background: #48bb78;
            color: white;
        }

        .error-retry-btn-small:hover {
            background: #38a169;
        }

        .toggle-prompt-btn:hover {
            background: #495057;
        }

        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(4, 1fr);
            }
            
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ æ•°å­¦å¯è§†åŒ–ç”Ÿæˆå™¨ - å¤šæ¨¡å‹å¹¶è¡Œå¤„ç†</h1>
        
        <div class="main-container">
            <div class="input-panel">
                <form id="problemForm" class="form">
                    <div class="form-group">
                        <label for="testCaseSelect">ğŸ“ é€‰æ‹©æµ‹è¯•é¢˜ç›®:</label>
                        <select id="testCaseSelect" class="select">
                            <option value="">-- è¯·é€‰æ‹©æµ‹è¯•é¢˜ç›® --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="problemText">ğŸ¤” æ•°å­¦é—®é¢˜æè¿°:</label>
                        <textarea id="problemText" rows="5" class="textarea" 
                                placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¦å¯è§†åŒ–çš„æ•°å­¦æ¦‚å¿µæˆ–é—®é¢˜..." required></textarea>
                    </div>
                    
                    <button type="submit" class="btn" id="submitBtn">
                        ğŸš€ åŒæ—¶å¤„ç†æ‰€æœ‰æ¨¡å‹
                    </button>
                    
                </form>
                
                <div id="globalStatus" class="status">
                    <div id="globalStatusText">å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…ä»»åŠ¡æäº¤...
                    </div>
                    <div class="progress-bar">
                        <div id="globalProgressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Prompt Information Panel -->
            <div class="prompt-info-panel" id="promptInfoPanel">
                <div class="prompt-section">
                    <h3>ğŸ“ System Prompt <span class="prompt-stats" id="systemPromptStats">é•¿åº¦: -- å­—ç¬¦</span></h3>
                    <div class="prompt-content" id="systemPromptContent">ç­‰å¾…ä»»åŠ¡æäº¤...</div>
                </div>
                <div class="prompt-section">
                    <h3>ğŸ’¬ User Prompt <span class="prompt-stats" id="userPromptStats">é•¿åº¦: -- å­—ç¬¦</span></h3>
                    <div class="prompt-content" id="userPromptContent">ç­‰å¾…ä»»åŠ¡æäº¤...</div>
                </div>
            </div>

            <div class="results-grid">
                <div class="model-result-panel" id="openaiPanel">
                    <div class="model-header">
                        <div class="model-name">ğŸ¤– OpenAI / Moonshot</div>
                        <div class="model-status status-waiting" id="openaiStatus">ç­‰å¾…ä¸­</div>
                    </div>
                    <div class="model-progress-bar">
                        <div class="model-progress-fill" id="openaiProgress" style="width: 0%"></div>
                    </div>
                    <div class="model-result-content">
                        <div class="model-image-container">
                            <img id="openaiImage" class="model-image" src="" alt="OpenAIç”Ÿæˆçš„å›¾è¡¨" style="display: none;">
                            <div id="openaiImagePlaceholder" class="image-placeholder">ç­‰å¾…å›¾è¡¨ç”Ÿæˆ...</div>
                        </div>
                        <div class="model-analysis">
                            <h4>ğŸ“Š åˆ†æç»“æœ</h4>
                            <div id="openaiAnalysis" class="model-analysis-content">ç­‰å¾…åˆ†æ...</div>
                        </div>
                        <div class="model-token-info">
                            <div class="token-label">ğŸ”¢ Tokenä½¿ç”¨:</div>
                            <div id="openaiTokens" class="token-details">ç­‰å¾…ä¸­...</div>
                        </div>
                        <div id="openaiTiming" class="model-timing">è€—æ—¶: --</div>
                        <div id="openaiErrorDetails" class="error-details-container" style="display: none;">
                            <div class="error-details-header" onclick="toggleErrorDetails('openai')">
                                <span>
                                    <span id="openaiErrorType" class="error-type-indicator">é”™è¯¯</span>
                                    <span id="openaiErrorTitle">æŸ¥çœ‹é”™è¯¯è¯¦æƒ…</span>
                                </span>
                                <span id="openaiErrorToggle">â–¼</span>
                            </div>
                            <div id="openaiErrorContent" class="error-details-content"></div>
                        </div>
                    </div>
                </div>

                <div class="model-result-panel" id="claudePanel">
                    <div class="model-header">
                        <div class="model-name">ğŸ§  Claude / Moonshot</div>
                        <div class="model-status status-waiting" id="claudeStatus">ç­‰å¾…ä¸­</div>
                    </div>
                    <div class="model-progress-bar">
                        <div class="model-progress-fill" id="claudeProgress" style="width: 0%"></div>
                    </div>
                    <div class="model-result-content">
                        <div class="model-image-container">
                            <img id="claudeImage" class="model-image" src="" alt="Claudeç”Ÿæˆçš„å›¾è¡¨" style="display: none;">
                            <div id="claudeImagePlaceholder" class="image-placeholder">ç­‰å¾…å›¾è¡¨ç”Ÿæˆ...</div>
                        </div>
                        <div class="model-analysis">
                            <h4>ğŸ“Š åˆ†æç»“æœ</h4>
                            <div id="claudeAnalysis" class="model-analysis-content">ç­‰å¾…åˆ†æ...</div>
                        </div>
                        <div class="model-token-info">
                            <div class="token-label">ğŸ”¢ Tokenä½¿ç”¨:</div>
                            <div id="claudeTokens" class="token-details">ç­‰å¾…ä¸­...</div>
                        </div>
                        <div id="claudeTiming" class="model-timing">è€—æ—¶: --</div>
                        <div id="claudeErrorDetails" class="error-details-container" style="display: none;">
                            <div class="error-details-header" onclick="toggleErrorDetails('claude')">
                                <span>
                                    <span id="claudeErrorType" class="error-type-indicator">é”™è¯¯</span>
                                    <span id="claudeErrorTitle">æŸ¥çœ‹é”™è¯¯è¯¦æƒ…</span>
                                </span>
                                <span id="claudeErrorToggle">â–¼</span>
                            </div>
                            <div id="claudeErrorContent" class="error-details-content"></div>
                        </div>
                    </div>
                </div>

                <div class="model-result-panel" id="qwenPanel">
                    <div class="model-header">
                        <div class="model-name">ğŸ”® Qwen</div>
                        <div class="model-status status-waiting" id="qwenStatus">ç­‰å¾…ä¸­</div>
                    </div>
                    <div class="model-progress-bar">
                        <div class="model-progress-fill" id="qwenProgress" style="width: 0%"></div>
                    </div>
                    <div class="model-result-content">
                        <div class="model-image-container">
                            <img id="qwenImage" class="model-image" src="" alt="Qwenç”Ÿæˆçš„å›¾è¡¨" style="display: none;">
                            <div id="qwenImagePlaceholder" class="image-placeholder">ç­‰å¾…å›¾è¡¨ç”Ÿæˆ...</div>
                        </div>
                        <div class="model-analysis">
                            <h4>ğŸ“Š åˆ†æç»“æœ</h4>
                            <div id="qwenAnalysis" class="model-analysis-content">ç­‰å¾…åˆ†æ...</div>
                        </div>
                        <div class="model-token-info">
                            <div class="token-label">ğŸ”¢ Tokenä½¿ç”¨:</div>
                            <div id="qwenTokens" class="token-details">ç­‰å¾…ä¸­...</div>
                        </div>
                        <div id="qwenTiming" class="model-timing">è€—æ—¶: --</div>
                        <div id="qwenErrorDetails" class="error-details-container" style="display: none;">
                            <div class="error-details-header" onclick="toggleErrorDetails('qwen')">
                                <span>
                                    <span id="qwenErrorType" class="error-type-indicator">é”™è¯¯</span>
                                    <span id="qwenErrorTitle">æŸ¥çœ‹é”™è¯¯è¯¦æƒ…</span>
                                </span>
                                <span id="qwenErrorToggle">â–¼</span>
                            </div>
                            <div id="qwenErrorContent" class="error-details-content"></div>
                        </div>
                    </div>
                </div>

                <div class="model-result-panel" id="deepseekPanel">
                    <div class="model-header">
                        <div class="model-name">ğŸš€ DeepSeek</div>
                        <div class="model-status status-waiting" id="deepseekStatus">ç­‰å¾…ä¸­</div>
                    </div>
                    <div class="model-progress-bar">
                        <div class="model-progress-fill" id="deepseekProgress" style="width: 0%"></div>
                    </div>
                    <div class="model-result-content">
                        <div class="model-image-container">
                            <img id="deepseekImage" class="model-image" src="" alt="DeepSeekç”Ÿæˆçš„å›¾è¡¨" style="display: none;">
                            <div id="deepseekImagePlaceholder" class="image-placeholder">ç­‰å¾…å›¾è¡¨ç”Ÿæˆ...</div>
                        </div>
                        <div class="model-analysis">
                            <h4>ğŸ“Š åˆ†æç»“æœ</h4>
                            <div id="deepseekAnalysis" class="model-analysis-content">ç­‰å¾…åˆ†æ...</div>
                        </div>
                        <div class="model-token-info">
                            <div class="token-label">ğŸ”¢ Tokenä½¿ç”¨:</div>
                            <div id="deepseekTokens" class="token-details">ç­‰å¾…ä¸­...</div>
                        </div>
                        <div id="deepseekTiming" class="model-timing">è€—æ—¶: --</div>
                        <div id="deepseekErrorDetails" class="error-details-container" style="display: none;">
                            <div class="error-details-header" onclick="toggleErrorDetails('deepseek')">
                                <span>
                                    <span id="deepseekErrorType" class="error-type-indicator">é”™è¯¯</span>
                                    <span id="deepseekErrorTitle">æŸ¥çœ‹é”™è¯¯è¯¦æƒ…</span>
                                </span>
                                <span id="deepseekErrorToggle">â–¼</span>
                            </div>
                            <div id="deepseekErrorContent" class="error-details-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_V2 = 'http://localhost:8001/api/v2';
        
        // 4ä¸ªæ¨¡å‹é…ç½®
        const MODEL_CONFIGS = {
            'openai': {
                name: 'OpenAI / Moonshot',
                emoji: 'ğŸ¤–',
                provider: 'openai'
            },
            'claude': {
                name: 'Claude / Moonshot',
                emoji: 'ğŸ§ ',
                provider: 'claude'
            },
            'qwen': {
                name: 'Qwen',
                emoji: 'ğŸ”®',
                provider: 'qwen'
            },
            'deepseek': {
                name: 'DeepSeek',
                emoji: 'ğŸš€',
                provider: 'deepseek'
            }
        };

        let testCases = [];
        let currentTasks = {}; // å­˜å‚¨4ä¸ªæ¨¡å‹çš„ä»»åŠ¡IDå’ŒçŠ¶æ€
        let modelTimers = {}; // æ¯ä¸ªæ¨¡å‹çš„è®¡æ—¶å™¨
        let taskStartTimes = {}; // ä»»åŠ¡å¼€å§‹æ—¶é—´

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–å¤šæ¨¡å‹å¹¶è¡Œå¤„ç†ç•Œé¢...');
            initializeEventListeners();
            loadTestCases();
        });

        // åŠ è½½æµ‹è¯•ç”¨ä¾‹
        async function loadTestCases() {
            try {
                console.log('å¼€å§‹åŠ è½½æµ‹è¯•ç”¨ä¾‹...');
                const response = await fetch('/math_test_case.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                console.log('æµ‹è¯•ç”¨ä¾‹JSONåŸå§‹æ–‡æœ¬:', text);
                
                testCases = JSON.parse(text);
                console.log('è§£ææµ‹è¯•ç”¨ä¾‹æˆåŠŸ:', testCases);
                
                populateTestCaseSelect();
            } catch (error) {
                console.error('åŠ è½½æµ‹è¯•ç”¨ä¾‹å¤±è´¥:', error);
                showGlobalStatus(`åŠ è½½æµ‹è¯•ç”¨ä¾‹å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¡«å……æµ‹è¯•ç”¨ä¾‹é€‰æ‹©æ¡†
        function populateTestCaseSelect() {
            const select = document.getElementById('testCaseSelect');
            testCases.forEach(testCase => {
                const option = document.createElement('option');
                option.value = testCase.id;
                option.textContent = testCase.title || `æµ‹è¯•ç”¨ä¾‹ ${testCase.id}`;
                select.appendChild(option);
            });
            console.log('æµ‹è¯•ç”¨ä¾‹é€‰æ‹©æ¡†å¡«å……å®Œæˆ');
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            console.log('å¼€å§‹åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨...');
            
            // æµ‹è¯•ç”¨ä¾‹é€‰æ‹©å˜åŒ– - è‡ªåŠ¨å¡«å……åˆ°è¾“å…¥æ¡†
            document.getElementById('testCaseSelect').addEventListener('change', function() {
                const selectedId = this.value;
                if (selectedId) {
                    const testCase = testCases.find(tc => tc.id === selectedId);
                    if (testCase) {
                        document.getElementById('problemText').value = testCase.original_text;
                        console.log('è‡ªåŠ¨åŠ è½½äº†æµ‹è¯•ç”¨ä¾‹:', selectedId);
                    }
                } else {
                    document.getElementById('problemText').value = '';
                }
            });
            
            // è¡¨å•æäº¤ - å¹¶è¡Œå¤„ç†æ‰€æœ‰æ¨¡å‹
            document.getElementById('problemForm').addEventListener('submit', handleMultiModelSubmit);
            
            console.log('äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ');
        }

        // å¤„ç†å¤šæ¨¡å‹å¹¶è¡Œæäº¤
        async function handleMultiModelSubmit(event) {
            event.preventDefault();
            
            console.log('=== å¼€å§‹è¡¨å•æäº¤å¤„ç† ===');
            
            const problemText = document.getElementById('problemText').value.trim();
            console.log('é—®é¢˜æ–‡æœ¬:', problemText);
            
            if (!problemText) {
                alert('è¯·è¾“å…¥æ•°å­¦é—®é¢˜æè¿°');
                return;
            }

            console.log('å¼€å§‹å¤šæ¨¡å‹å¹¶è¡Œå¤„ç†:', problemText);
            
            try {
                // ç¦ç”¨æäº¤æŒ‰é’®
                document.getElementById('submitBtn').disabled = true;
                
                // é‡ç½®æ‰€æœ‰æ¨¡å‹çš„çŠ¶æ€
                resetAllModels();
                
                // æ˜¾ç¤ºå…¨å±€çŠ¶æ€
                showGlobalStatus('æ­£åœ¨å¯åŠ¨æ‰€æœ‰æ¨¡å‹...', 'processing', 0);
                
                console.log('å‡†å¤‡å¯åŠ¨æ¨¡å‹...');
                
                // å¹¶è¡Œå¯åŠ¨æ‰€æœ‰4ä¸ªæ¨¡å‹
                const providers = Object.keys(MODEL_CONFIGS);
                console.log('æä¾›å•†åˆ—è¡¨:', providers);
                
                const promises = providers.map(provider => {
                    console.log(`å‡†å¤‡æäº¤åˆ° ${provider}`);
                    return submitToModel(provider, problemText);
                });
                
                // ç­‰å¾…æ‰€æœ‰æ¨¡å‹å¯åŠ¨ï¼ˆä¸ç­‰å¾…å®Œæˆï¼‰
                const results = await Promise.allSettled(promises);
                console.log('æ‰€æœ‰æ¨¡å‹å¯åŠ¨ç»“æœ:', results);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥çš„å¯åŠ¨
                const failures = results.filter(result => result.status === 'rejected');
                if (failures.length > 0) {
                    console.error('éƒ¨åˆ†æ¨¡å‹å¯åŠ¨å¤±è´¥:', failures);
                    showGlobalStatus(`éƒ¨åˆ†æ¨¡å‹å¯åŠ¨å¤±è´¥ (${failures.length}/${providers.length})`, 'warning', 25);
                } else {
                    console.log('æ‰€æœ‰æ¨¡å‹å·²å¯åŠ¨');
                    showGlobalStatus('æ‰€æœ‰æ¨¡å‹å·²å¯åŠ¨ï¼Œæ­£åœ¨å¹¶è¡Œå¤„ç†...', 'processing', 25);
                }
            } catch (error) {
                console.error('å¯åŠ¨æ¨¡å‹æ—¶å‡ºé”™:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                showGlobalStatus(`å¯åŠ¨æ¨¡å‹å¤±è´¥: ${error.message}`, 'error');
            } finally {
                // é‡æ–°å¯ç”¨æäº¤æŒ‰é’®
                document.getElementById('submitBtn').disabled = false;
                console.log('=== è¡¨å•æäº¤å¤„ç†å®Œæˆ ===');
            }
        }

        // é‡ç½®æ‰€æœ‰æ¨¡å‹çŠ¶æ€
        function resetAllModels() {
            const providers = Object.keys(MODEL_CONFIGS);
            providers.forEach(provider => {
                // é‡ç½®çŠ¶æ€
                updateModelStatus(provider, 'å‡†å¤‡ä¸­', 'processing');
                updateModelProgress(provider, 0);
                
                // æ¸…ç©ºå†…å®¹ï¼Œæ·»åŠ nullæ£€æŸ¥
                const imageElement = document.getElementById(`${provider}Image`);
                const placeholderElement = document.getElementById(`${provider}ImagePlaceholder`);
                const analysisElement = document.getElementById(`${provider}Analysis`);
                const timingElement = document.getElementById(`${provider}Timing`);
                
                if (imageElement) {
                    imageElement.style.display = 'none';
                    imageElement.src = '';
                }
                if (placeholderElement) {
                    placeholderElement.style.display = 'flex';
                    placeholderElement.textContent = 'ç­‰å¾…å›¾è¡¨ç”Ÿæˆ...';
                }
                if (analysisElement) {
                    analysisElement.textContent = 'ç­‰å¾…åˆ†æ...';
                }
                if (timingElement) {
                    timingElement.textContent = 'è€—æ—¶: --';
                }
                
                // æ¸…é™¤å®šæ—¶å™¨
                if (modelTimers[provider]) {
                    clearInterval(modelTimers[provider]);
                    delete modelTimers[provider];
                }
            });
            
            // é‡ç½®å…¨å±€çŠ¶æ€
            currentTasks = {};
            taskStartTimes = {};
        }

        // æäº¤åˆ°å•ä¸ªæ¨¡å‹
        async function submitToModel(provider, problemText) {
            try {
                console.log(`=== å¼€å§‹æäº¤åˆ° ${provider} æ¨¡å‹ ===`);
                console.log(`é—®é¢˜æ–‡æœ¬:`, problemText);
                console.log(`APIåœ°å€:`, API_BASE_V2);
                
                updateModelStatus(provider, 'æäº¤ä¸­', 'processing');
                updateModelProgress(provider, 10);
                
                const requestData = {
                    text: problemText,
                    user_id: 'demo_user',
                    llm_provider: provider,
                    processing_mode: 'ai',
                    prompt_variant: 'default'
                };
                
                console.log(`${provider} è¯·æ±‚æ•°æ®:`, requestData);
                
                const response = await fetch(`${API_BASE_V2}/problems/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log(`${provider} å“åº”çŠ¶æ€:`, response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const taskId = data.task_id;
                
                console.log(`${provider} ä»»åŠ¡å·²æäº¤ï¼Œä»»åŠ¡ID:`, taskId);
                
                // å­˜å‚¨ä»»åŠ¡ä¿¡æ¯
                currentTasks[provider] = taskId;
                taskStartTimes[provider] = Date.now();
                
                updateModelStatus(provider, 'å¤„ç†ä¸­', 'processing');
                updateModelProgress(provider, 20);
                
                // å¯åŠ¨çŠ¶æ€è½®è¯¢
                startModelStatusPolling(provider, taskId);
                
            } catch (error) {
                console.error(`${provider} æ¨¡å‹æäº¤å¤±è´¥:`, error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                updateModelStatus(provider, `æäº¤å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // å¼€å§‹è½®è¯¢æ¨¡å‹çŠ¶æ€
        function startModelStatusPolling(provider, taskId) {
            if (modelTimers[provider]) {
                clearInterval(modelTimers[provider]);
            }
            
            modelTimers[provider] = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE_V2}/tasks/${taskId}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log(`${provider} çŠ¶æ€æ›´æ–°:`, data);
                    
                    // æ›´æ–°è€—æ—¶æ˜¾ç¤º
                    const elapsed = Math.round((Date.now() - taskStartTimes[provider]) / 1000);
                    document.getElementById(`${provider}Timing`).textContent = `è€—æ—¶: ${elapsed}s`;
                    
                    // æ ¹æ®çŠ¶æ€æ›´æ–°è¿›åº¦å’Œæ˜¾ç¤º
                    if (data.status === 'completed') {
                        clearInterval(modelTimers[provider]);
                        delete modelTimers[provider];
                        await handleModelCompletion(provider, data);
                        checkAllModelsCompletion();
                    } else if (data.status === 'failed' || data.status === 'ai_analysis_failed' || data.status === 'code_execution_failed' || data.status === 'api_error') {
                        clearInterval(modelTimers[provider]);
                        delete modelTimers[provider];
                        handleModelError(provider, data);
                        checkAllModelsCompletion();
                    } else if (data.status === 'processing') {
                        updateModelStatus(provider, 'ç”Ÿæˆä¸­', 'processing');
                        updateModelProgress(provider, Math.min(80, 20 + elapsed * 2));
                    }
                    
                } catch (error) {
                    console.error(`${provider} çŠ¶æ€æŸ¥è¯¢å¤±è´¥:`, error);
                }
            }, 2000);
        }

        // å¤„ç†æ¨¡å‹å®Œæˆ
        async function handleModelCompletion(provider, data) {
            console.log(`${provider} å¤„ç†å®Œæˆ:`, data);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯è¯¦æƒ…
            if (data.error_details || data.status.includes('failed') || data.status.includes('error')) {
                handleModelError(provider, data);
                return;
            }
            
            // è°ƒè¯•æ—¥å¿—
            if (data.ai_analysis) {
                console.log(`${provider} AIåˆ†ææ•°æ®:`, data.ai_analysis);
                if (data.ai_analysis.llm_interaction) {
                    console.log(`${provider} LLMäº¤äº’æ•°æ®:`, data.ai_analysis.llm_interaction);
                    if (data.ai_analysis.llm_interaction.usage_stats) {
                        console.log(`${provider} Tokenä½¿ç”¨ç»Ÿè®¡:`, data.ai_analysis.llm_interaction.usage_stats);
                    }
                }
            }
            
            updateModelStatus(provider, 'å®Œæˆ', 'completed');
            updateModelProgress(provider, 100);
            
            // éšè—é”™è¯¯è¯¦æƒ…ï¼ˆå¦‚æœä¹‹å‰æ˜¾ç¤ºè¿‡ï¼‰
            hideErrorDetails(provider);
            
            // æ˜¾ç¤ºç»“æœå›¾ç‰‡
            if (data.execution_result && data.execution_result.image_path) {
                const imageElement = document.getElementById(`${provider}Image`);
                const imageContainer = imageElement ? imageElement.parentElement : null;
                
                if (imageContainer) {
                    // æ¢å¤åŸæœ‰çš„å›¾ç‰‡å®¹å™¨ç»“æ„ï¼ˆå¦‚æœè¢«é”™è¯¯æ˜¾ç¤ºæ›¿æ¢è¿‡ï¼‰
                    if (!document.getElementById(`${provider}Image`) || !document.getElementById(`${provider}ImagePlaceholder`)) {
                        imageContainer.innerHTML = `
                            <img id="${provider}Image" class="model-image" src="" alt="${provider}ç”Ÿæˆçš„å›¾è¡¨" style="display: none;">
                            <div id="${provider}ImagePlaceholder" class="image-placeholder">ç­‰å¾…å›¾è¡¨ç”Ÿæˆ...</div>
                        `;
                    }
                    
                    const refreshedImageElement = document.getElementById(`${provider}Image`);
                    const placeholderElement = document.getElementById(`${provider}ImagePlaceholder`);
                    
                    if (refreshedImageElement && placeholderElement) {
                        // ä»è·¯å¾„ä¸­æå–æ–‡ä»¶åï¼Œä¾‹å¦‚ "output/abc123.png" -> "abc123.png"
                        const imagePath = data.execution_result.image_path;
                        const filename = imagePath.split('/').pop(); // è·å–æ–‡ä»¶åéƒ¨åˆ†
                        const imageUrl = `${API_BASE_V2}/images/${filename}`;
                        console.log(`${provider} å›¾ç‰‡URL:`, imageUrl);
                        
                        refreshedImageElement.src = imageUrl;
                        refreshedImageElement.style.display = 'block';
                        placeholderElement.style.display = 'none';
                    }
                }
            }
            
            // æ˜¾ç¤ºåˆ†æç»“æœ
            if (data.ai_analysis && data.ai_analysis.explanation) {
                const analysisElement = document.getElementById(`${provider}Analysis`);
                analysisElement.textContent = data.ai_analysis.explanation;
            }
            
            // æ›´æ–°Tokenä½¿ç”¨ä¿¡æ¯
            if (data.ai_analysis && data.ai_analysis.llm_interaction && data.ai_analysis.llm_interaction.usage_stats) {
                updateTokenInfo(provider, data.ai_analysis.llm_interaction.usage_stats);
            }
            
            // å¯¹äºç¬¬ä¸€ä¸ªå®Œæˆçš„æ¨¡å‹ï¼Œæ˜¾ç¤ºPromptä¿¡æ¯ï¼ˆå› ä¸ºæ‰€æœ‰æ¨¡å‹ä½¿ç”¨ç›¸åŒçš„promptï¼‰
            if (data.ai_analysis && data.ai_analysis.llm_interaction) {
                console.log(`${provider} LLMäº¤äº’æ•°æ®è¯¦æƒ…:`, data.ai_analysis.llm_interaction);
                
                if (data.ai_analysis.llm_interaction.system_prompt) {
                    console.log(`${provider} ç³»ç»ŸPrompt:`, data.ai_analysis.llm_interaction.system_prompt);
                }
                
                if (data.ai_analysis.llm_interaction.user_prompt) {
                    console.log(`${provider} ç”¨æˆ·Prompt:`, data.ai_analysis.llm_interaction.user_prompt);
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºäº†promptä¿¡æ¯
                const systemPromptElement = document.getElementById('systemPromptContent');
                if (!systemPromptElement.textContent || systemPromptElement.textContent === 'ç­‰å¾…ä»»åŠ¡æäº¤...') {
                    console.log(`${provider} æ­£åœ¨æ˜¾ç¤ºPromptä¿¡æ¯...`);
                    updatePromptInfo(
                        data.ai_analysis.llm_interaction.system_prompt, 
                        data.ai_analysis.llm_interaction.user_prompt
                    );
                } else {
                    console.log(`${provider} Promptä¿¡æ¯å·²å­˜åœ¨ï¼Œè·³è¿‡æ˜¾ç¤º`);
                }
            } else {
                console.log(`${provider} ç¼ºå°‘LLMäº¤äº’æ•°æ®:`, data.ai_analysis?.llm_interaction);
            }
        }

        // å¤„ç†æ¨¡å‹é”™è¯¯
        function handleModelError(provider, data) {
            console.log(`${provider} å¤„ç†å¤±è´¥:`, data);
            
            // æ›´æ–°çŠ¶æ€ä¸ºå¤±è´¥
            updateModelStatus(provider, 'å¤„ç†å¤±è´¥', 'failed');
            updateModelProgress(provider, 0);
            
            // è·å–é”™è¯¯è¯¦æƒ…
            let errorDetails = data.error_details;
            if (!errorDetails && data.error_message) {
                // å¦‚æœæ²¡æœ‰è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„é”™è¯¯è¯¦æƒ…
                errorDetails = {
                    error_type: data.failure_type || 'unknown_error',
                    error_message: data.error_message,
                    timestamp: new Date().toISOString()
                };
            }
            
            if (errorDetails) {
                // æ›¿æ¢å›¾ç‰‡åŒºåŸŸæ˜¾ç¤ºé”™è¯¯
                replaceImageWithError(provider, errorDetails);
                // éšè—åŸæœ‰çš„é”™è¯¯è¯¦æƒ…åŒºåŸŸ
                hideErrorDetails(provider);
            }
        }

        // æ›¿æ¢å›¾ç‰‡åŒºåŸŸæ˜¾ç¤ºé”™è¯¯
        function replaceImageWithError(provider, errorDetails) {
            const imageContainer = document.getElementById(`${provider}Image`).parentElement;
            
            // åˆ›å»ºé”™è¯¯æ˜¾ç¤ºHTML
            const errorIcon = getErrorIcon(errorDetails.error_type);
            const errorTypeName = getErrorTypeName(errorDetails.error_type);
            
            const errorHtml = `
                <div class="error-image-replacement ${errorDetails.error_type}">
                    <div class="error-icon">${errorIcon}</div>
                    <div class="error-title">${errorTypeName}</div>
                    <div class="error-subtitle">${errorDetails.error_message}</div>
                    <div class="error-actions-inline">
                        <button class="error-action-btn-small error-view-btn" onclick="showErrorModal('${provider}', '${errorDetails.timestamp}')">
                            ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…
                        </button>
                        <button class="error-action-btn-small error-retry-btn-small" onclick="retryModel('${provider}')">
                            ğŸ”„ é‡è¯•
                        </button>
                    </div>
                </div>
            `;
            
            imageContainer.innerHTML = errorHtml;
            
            // å°†é”™è¯¯è¯¦æƒ…å­˜å‚¨åˆ°å…¨å±€å˜é‡ä¸­ä¾›æ¨¡æ€æ¡†ä½¿ç”¨
            if (!window.errorDetailsStorage) {
                window.errorDetailsStorage = {};
            }
            window.errorDetailsStorage[`${provider}_${errorDetails.timestamp}`] = errorDetails;
        }

        // è·å–é”™è¯¯å›¾æ ‡
        function getErrorIcon(errorType) {
            switch(errorType) {
                case 'api_error':
                    return 'ğŸ”Œ';
                case 'ai_analysis_failed':
                    return 'ğŸ¤–';
                case 'code_execution_failed':
                    return 'âš ï¸';
                default:
                    return 'âŒ';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…æ¨¡æ€æ¡†
        function showErrorModal(provider, timestamp) {
            const errorDetails = window.errorDetailsStorage[`${provider}_${timestamp}`];
            if (!errorDetails) {
                console.error('æœªæ‰¾åˆ°é”™è¯¯è¯¦æƒ…');
                return;
            }
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modalHtml = `
                <div id="errorModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                " onclick="closeErrorModal(event)">
                    <div style="
                        background: white;
                        border-radius: 8px;
                        max-width: 600px;
                        max-height: 80vh;
                        overflow-y: auto;
                        padding: 0;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    " onclick="event.stopPropagation()">
                        <div style="
                            padding: 20px;
                            border-bottom: 1px solid #e2e8f0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h3 style="margin: 0; color: #2d3748;">${getErrorTypeName(errorDetails.error_type)} - è¯¦ç»†ä¿¡æ¯</h3>
                            <button onclick="closeErrorModal()" style="
                                background: none;
                                border: none;
                                font-size: 20px;
                                cursor: pointer;
                                color: #718096;
                            ">Ã—</button>
                        </div>
                        <div style="padding: 20px;">
                            ${createErrorContent(errorDetails)}
                            <div style="margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end;">
                                <button onclick="copyErrorDetails('${timestamp}')" style="
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    padding: 8px 16px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                ">å¤åˆ¶é”™è¯¯ä¿¡æ¯</button>
                                <button onclick="retryModel('${timestamp}')" style="
                                    background: #28a745;
                                    color: white;
                                    border: none;
                                    padding: 8px 16px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                ">é‡è¯•</button>
                                <button onclick="closeErrorModal()" style="
                                    background: #4299e1;
                                    color: white;
                                    border: none;
                                    padding: 8px 16px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                ">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ¨¡æ€æ¡†åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // å…³é—­é”™è¯¯æ¨¡æ€æ¡†
        function closeErrorModal(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            const modal = document.getElementById('errorModal');
            if (modal) {
                modal.remove();
            }
        }

        // æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…
        function displayErrorDetails(provider, errorDetails) {
            const errorContainer = document.getElementById(`${provider}ErrorDetails`);
            const errorTypeElement = document.getElementById(`${provider}ErrorType`);
            const errorTitleElement = document.getElementById(`${provider}ErrorTitle`);
            const errorContentElement = document.getElementById(`${provider}ErrorContent`);
            
            if (!errorContainer || !errorTypeElement || !errorTitleElement || !errorContentElement) {
                console.warn(`Error detail elements not found for provider: ${provider}`);
                return;
            }
            
            // è®¾ç½®é”™è¯¯ç±»å‹æ ‡è¯†
            errorTypeElement.className = `error-type-indicator error-type-${errorDetails.error_type}`;
            errorTypeElement.textContent = getErrorTypeName(errorDetails.error_type);
            
            // è®¾ç½®é”™è¯¯æ ‡é¢˜
            errorTitleElement.textContent = errorDetails.error_message;
            
            // åˆ›å»ºé”™è¯¯å†…å®¹
            const errorContent = createErrorContent(errorDetails);
            errorContentElement.innerHTML = errorContent;
            
            // æ˜¾ç¤ºé”™è¯¯å®¹å™¨
            errorContainer.style.display = 'block';
        }

        // éšè—é”™è¯¯è¯¦æƒ…
        function hideErrorDetails(provider) {
            const errorContainer = document.getElementById(`${provider}ErrorDetails`);
            if (errorContainer) {
                errorContainer.style.display = 'none';
            }
        }

        // æ£€æŸ¥æ‰€æœ‰æ¨¡å‹æ˜¯å¦å®Œæˆ
        function checkAllModelsCompletion() {
            const providers = Object.keys(MODEL_CONFIGS);
            const completedCount = providers.filter(provider => {
                const status = document.getElementById(`${provider}Status`).textContent;
                return status === 'å®Œæˆ' || status === 'å¤„ç†å¤±è´¥';
            }).length;
            
            if (completedCount === providers.length) {
                console.log('æ‰€æœ‰æ¨¡å‹å¤„ç†å®Œæˆ');
                showGlobalStatus('æ‰€æœ‰æ¨¡å‹å¤„ç†å®Œæˆï¼', 'completed', 100);
            } else {
                const progress = Math.round((completedCount / providers.length) * 75) + 25;
                showGlobalStatus(`å·²å®Œæˆ ${completedCount}/${providers.length} ä¸ªæ¨¡å‹`, 'processing', progress);
            }
        }

        // æ›´æ–°æ¨¡å‹çŠ¶æ€
        function updateModelStatus(provider, statusText, statusClass) {
            const statusElement = document.getElementById(`${provider}Status`);
            if (statusElement) {
                statusElement.textContent = statusText;
                statusElement.className = `model-status status-${statusClass}`;
            }
        }

        // æ›´æ–°æ¨¡å‹è¿›åº¦
        function updateModelProgress(provider, percentage) {
            const progressElement = document.getElementById(`${provider}Progress`);
            if (progressElement) {
                progressElement.style.width = `${percentage}%`;
            }
        }

        // æ˜¾ç¤ºå…¨å±€çŠ¶æ€
        function showGlobalStatus(message, type, progress = null) {
            const statusText = document.getElementById('globalStatusText');
            const progressFill = document.getElementById('globalProgressFill');
            
            if (statusText) {
                statusText.textContent = message;
            }
            
            if (progress !== null && progressFill) {
                progressFill.style.width = `${progress}%`;
            }
            
            console.log('å…¨å±€çŠ¶æ€æ›´æ–°:', message, type, progress);
        }

        // åˆ‡æ¢Promptä¿¡æ¯æ˜¾ç¤º
        function togglePromptInfo() {
            const panel = document.getElementById('promptInfoPanel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // æ›´æ–°Promptä¿¡æ¯æ˜¾ç¤º
        function updatePromptInfo(systemPrompt, userPrompt) {
            console.log('updatePromptInfo è¢«è°ƒç”¨ï¼š', { systemPrompt: systemPrompt?.length, userPrompt: userPrompt?.length });
            
            // æ›´æ–°ç³»ç»ŸPromptå†…å®¹
            const systemPromptElement = document.getElementById('systemPromptContent');
            const systemPromptStatsElement = document.getElementById('systemPromptStats');
            if (systemPromptElement && systemPrompt) {
                systemPromptElement.textContent = systemPrompt;
                systemPromptStatsElement.textContent = `é•¿åº¦: ${systemPrompt.length} å­—ç¬¦`;
                console.log('ç³»ç»ŸPromptå·²æ›´æ–°');
            }
            
            // æ›´æ–°ç”¨æˆ·Promptå†…å®¹
            const userPromptElement = document.getElementById('userPromptContent');
            const userPromptStatsElement = document.getElementById('userPromptStats');
            if (userPromptElement && userPrompt) {
                userPromptElement.textContent = userPrompt;
                userPromptStatsElement.textContent = `é•¿åº¦: ${userPrompt.length} å­—ç¬¦`;
                console.log('ç”¨æˆ·Promptå·²æ›´æ–°');
            }
            
            // æ˜¾ç¤ºToggleæŒ‰é’®
            const toggleBtn = document.getElementById('togglePromptBtn');
            if (toggleBtn) {
                toggleBtn.style.display = 'inline-block';
                console.log('ToggleæŒ‰é’®å·²æ˜¾ç¤º');
            }
            
            // æ˜¾ç¤ºPrompté¢æ¿
            const promptPanel = document.getElementById('promptInfoPanel');
            if (promptPanel) {
                promptPanel.style.display = 'block';
                console.log('Prompté¢æ¿å·²æ˜¾ç¤º');
            }
        }

        // æ›´æ–°å„ä¸ªæ¨¡å‹çš„Tokenä½¿ç”¨ä¿¡æ¯
        function updateTokenInfo(provider, tokenData) {
            const tokenElement = document.getElementById(`${provider}Tokens`);
            if (tokenData && tokenData.input_tokens && tokenData.output_tokens && tokenData.total_tokens) {
                tokenElement.innerHTML = `
                    <div>è¾“å…¥: ${tokenData.input_tokens.toLocaleString()}</div>
                    <div>è¾“å‡º: ${tokenData.output_tokens.toLocaleString()}</div>
                    <div>æ€»è®¡: ${tokenData.total_tokens.toLocaleString()}</div>
                `;
            } else {
                tokenElement.textContent = 'æš‚æ— æ•°æ®';
            }
        }

        // é”™è¯¯å¤„ç†ç›¸å…³å‡½æ•°

        // è·å–é”™è¯¯ç±»å‹çš„æ˜¾ç¤ºåç§°
        function getErrorTypeName(errorType) {
            const typeNames = {
                'api_error': 'APIé”™è¯¯',
                'json_parse_error': 'JSONè§£æé”™è¯¯', 
                'validation_error': 'éªŒè¯é”™è¯¯',
                'code_execution_failed': 'ä»£ç æ‰§è¡Œå¤±è´¥',
                'exception': 'ç¨‹åºå¼‚å¸¸',
                'max_retries_exceeded': 'é‡è¯•æ¬¡æ•°è¶…é™',
                'unknown_error': 'æœªçŸ¥é”™è¯¯'
            };
            return typeNames[errorType] || 'æœªçŸ¥é”™è¯¯';
        }

        // åˆ›å»ºé”™è¯¯å†…å®¹HTML
        function createErrorContent(errorDetails) {
            let content = '';
            
            // æ·»åŠ é”™è¯¯ä¿¡æ¯é€‰æ‹©é€‰é¡¹
            content += `
                <div class="error-toggle-options">
                    <label>æ˜¾ç¤ºæ¨¡å¼:</label>
                    <input type="radio" id="simple_${errorDetails.timestamp}" name="errorMode_${errorDetails.timestamp}" value="simple" checked onchange="toggleErrorMode(this, '${errorDetails.timestamp}')">
                    <label for="simple_${errorDetails.timestamp}">ç®€åŒ–ç‰ˆ</label>
                    <input type="radio" id="detailed_${errorDetails.timestamp}" name="errorMode_${errorDetails.timestamp}" value="detailed" onchange="toggleErrorMode(this, '${errorDetails.timestamp}')">
                    <label for="detailed_${errorDetails.timestamp}">è¯¦ç»†ä¿¡æ¯</label>
                </div>
            `;

            // ç®€åŒ–ç‰ˆå†…å®¹
            content += `<div id="simple_content_${errorDetails.timestamp}" class="error-view-content">`;
            
            // é”™è¯¯æ¶ˆæ¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
            content += `
                <div class="error-section">
                    <div class="error-section-title">é”™è¯¯ä¿¡æ¯</div>
                    <div class="error-message-block">${escapeHtml(errorDetails.error_message)}</div>
                </div>
            `;

            // å¦‚æœæœ‰ç”Ÿæˆçš„ä»£ç ï¼Œæ˜¾ç¤ºä»£ç é¢„è§ˆï¼ˆç®€åŒ–ç‰ˆåªæ˜¾ç¤ºå‰500å­—ç¬¦ï¼‰
            if (errorDetails.generated_code) {
                const codePreview = errorDetails.generated_code.length > 500 
                    ? errorDetails.generated_code.substring(0, 500) + '...\n\n[åˆ‡æ¢åˆ°"è¯¦ç»†ä¿¡æ¯"æŸ¥çœ‹å®Œæ•´ä»£ç ]'
                    : errorDetails.generated_code;
                content += `
                    <div class="error-section">
                        <div class="error-section-title">ç”Ÿæˆçš„ä»£ç </div>
                        <div class="error-code-block">${escapeHtml(codePreview)}</div>
                    </div>
                `;
            }

            content += `</div>`;

            // è¯¦ç»†ç‰ˆå†…å®¹
            content += `<div id="detailed_content_${errorDetails.timestamp}" class="error-view-content" style="display: none;">`;
            
            // é”™è¯¯æ¶ˆæ¯ï¼ˆè¯¦ç»†ç‰ˆï¼‰
            content += `
                <div class="error-section">
                    <div class="error-section-title">é”™è¯¯ä¿¡æ¯</div>
                    <div class="error-message-block">${escapeHtml(errorDetails.error_message)}</div>
                </div>
            `;

            // APIå“åº”ï¼ˆè¯¦ç»†ç‰ˆï¼‰
            if (errorDetails.api_response) {
                content += `
                    <div class="error-section">
                        <div class="error-section-title">APIå“åº”</div>
                        <div class="error-api-response">${escapeHtml(errorDetails.api_response)}</div>
                    </div>
                `;
            }

            // ç”Ÿæˆçš„ä»£ç ï¼ˆè¯¦ç»†ç‰ˆ - å®Œæ•´ä»£ç ï¼‰
            if (errorDetails.generated_code) {
                content += `
                    <div class="error-section">
                        <div class="error-section-title">å®Œæ•´ç”Ÿæˆçš„ä»£ç </div>
                        <div class="error-code-block">${escapeHtml(errorDetails.generated_code)}</div>
                    </div>
                `;
            }

            // éªŒè¯é”™è¯¯ï¼ˆè¯¦ç»†ç‰ˆï¼‰
            if (errorDetails.validation_errors && errorDetails.validation_errors.length > 0) {
                content += `
                    <div class="error-section">
                        <div class="error-section-title">éªŒè¯é”™è¯¯</div>
                        <div class="error-validation-list">
                            <ul>
                                ${errorDetails.validation_errors.map(error => `<li>${escapeHtml(error)}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }

            // å †æ ˆè·Ÿè¸ªï¼ˆè¯¦ç»†ç‰ˆï¼‰
            if (errorDetails.stack_trace) {
                content += `
                    <div class="error-section">
                        <div class="error-section-title">å †æ ˆè·Ÿè¸ª</div>
                        <div class="error-code-block">${escapeHtml(errorDetails.stack_trace)}</div>
                    </div>
                `;
            }

            // æ‰§è¡Œæ—¥å¿—ï¼ˆè¯¦ç»†ç‰ˆï¼‰
            if (errorDetails.execution_logs) {
                content += `
                    <div class="error-section">
                        <div class="error-section-title">æ‰§è¡Œæ—¥å¿—</div>
                        <div class="error-api-response">${escapeHtml(errorDetails.execution_logs)}</div>
                    </div>
                `;
            }

            content += `</div>`;

            return content;
        }

        // åˆ‡æ¢é”™è¯¯æ˜¾ç¤ºæ¨¡å¼
        function toggleErrorMode(radio, timestamp) {
            const simpleContent = document.getElementById(`simple_content_${timestamp}`);
            const detailedContent = document.getElementById(`detailed_content_${timestamp}`);
            
            // æ£€æŸ¥DOMå…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé¿å…nullé”™è¯¯
            if (!simpleContent || !detailedContent) {
                console.warn(`Error content elements not found for timestamp: ${timestamp}`);
                return;
            }
            
            if (radio.value === 'simple') {
                simpleContent.style.display = 'block';
                detailedContent.style.display = 'none';
            } else {
                simpleContent.style.display = 'none';
                detailedContent.style.display = 'block';
            }
        }

        // åˆ‡æ¢é”™è¯¯è¯¦æƒ…å±•å¼€/æŠ˜å 
        function toggleErrorDetails(provider) {
            const content = document.getElementById(`${provider}ErrorContent`);
            const toggle = document.getElementById(`${provider}ErrorToggle`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.textContent = 'â–¼';
            } else {
                content.classList.add('expanded');
                toggle.textContent = 'â–²';
            }
        }

        // å¤åˆ¶é”™è¯¯è¯¦æƒ…åˆ°å‰ªè´´æ¿
        function copyErrorDetails(timestamp) {
            try {
                // æ„å»ºé”™è¯¯ä¿¡æ¯æ–‡æœ¬
                let errorText = '';
                
                // ä»æ¨¡æ€æ¡†ä¸­è·å–é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæ¨¡æ€æ¡†å­˜åœ¨çš„è¯
                const modal = document.getElementById('errorModal');
                if (modal) {
                    const title = modal.querySelector('h3');
                    if (title) {
                        errorText += `${title.textContent}\n`;
                        errorText += '='.repeat(50) + '\n\n';
                    }
                    
                    // è·å–é”™è¯¯å†…å®¹
                    const errorSections = modal.querySelectorAll('.error-section');
                    errorSections.forEach(section => {
                        const titleElement = section.querySelector('.error-section-title');
                        const contentElement = section.querySelector('.error-message-block, .error-code-block, .error-api-response, .error-validation-list');
                        
                        if (titleElement && contentElement) {
                            errorText += `${titleElement.textContent}:\n`;
                            errorText += `${contentElement.textContent}\n\n`;
                        }
                    });
                } else {
                    // å¦‚æœæ²¡æœ‰æ¨¡æ€æ¡†ï¼Œæä¾›åŸºæœ¬çš„é”™è¯¯ä¿¡æ¯
                    errorText = `é”™è¯¯æ—¶é—´æˆ³: ${timestamp}\næ— æ³•è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ç•Œé¢ä¸Šçš„é”™è¯¯æ˜¾ç¤ºã€‚`;
                }
                
                // æ·»åŠ æ—¶é—´æˆ³ä¿¡æ¯
                errorText += `\næ—¶é—´æˆ³: ${timestamp}\n`;
                errorText += `å¤åˆ¶æ—¶é—´: ${new Date().toLocaleString()}\n`;
                
                // ä½¿ç”¨ Clipboard API å¤åˆ¶åˆ°å‰ªè´´æ¿
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(errorText).then(() => {
                        alert('âœ… é”™è¯¯ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }).catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                        fallbackCopyTextToClipboard(errorText);
                    });
                } else {
                    // å…¼å®¹æ€§å›é€€æ–¹æ¡ˆ
                    fallbackCopyTextToClipboard(errorText);
                }
            } catch (error) {
                console.error('å¤åˆ¶é”™è¯¯ä¿¡æ¯å¤±è´¥:', error);
                alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶é”™è¯¯ä¿¡æ¯');
            }
        }
        
        // å…¼å®¹æ€§å¤åˆ¶å‡½æ•°
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            textArea.style.padding = '0';
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            textArea.style.background = 'transparent';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('âœ… é”™è¯¯ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } else {
                    alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶é”™è¯¯ä¿¡æ¯');
                }
            } catch (err) {
                console.error('Fallback: å¤åˆ¶å¤±è´¥:', err);
                alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶é”™è¯¯ä¿¡æ¯');
            }
            
            document.body.removeChild(textArea);
        }

        // é‡è¯•æ¨¡å‹
        function retryModel(provider) {
            // è¿™é‡Œå¯ä»¥å®ç°é‡è¯•åŠŸèƒ½
            console.log('é‡è¯•æ¨¡å‹:', provider);
            alert('é‡è¯•åŠŸèƒ½å°šæœªå®ç°');
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è·å–é”™è¯¯ç±»å‹åç§°
        function getErrorTypeName(errorType) {
            const typeNames = {
                'api_error': 'APIé”™è¯¯',
                'json_parse_error': 'JSONè§£æé”™è¯¯',
                'validation_error': 'éªŒè¯é”™è¯¯',
                'code_execution_failed': 'ä»£ç æ‰§è¡Œå¤±è´¥',
                'exception': 'ç¨‹åºå¼‚å¸¸',
                'max_retries_exceeded': 'é‡è¯•æ¬¡æ•°è¶…é™',
                'unknown_error': 'æœªçŸ¥é”™è¯¯'
            };
            return typeNames[errorType] || 'æœªçŸ¥é”™è¯¯';
        }

        // åˆ›å»ºé”™è¯¯å†…å®¹HTML
        // æµ‹è¯•é”™è¯¯åœºæ™¯å‡½æ•°
        async function testErrorScenario(errorType) {
            try {
                console.log(`å¼€å§‹æµ‹è¯•${errorType}é”™è¯¯åœºæ™¯...`);
                
                // è°ƒç”¨åç«¯æµ‹è¯•ç«¯ç‚¹
                const response = await fetch(`${API_BASE_V2}/test/error/${errorType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log(`${errorType}æµ‹è¯•å“åº”:`, data);

                const taskId = data.task_id;

                // è·å–ä»»åŠ¡è¯¦æƒ…
                const taskResponse = await fetch(`${API_BASE_V2}/tasks/${taskId}`);
                if (taskResponse.ok) {
                    const taskData = await taskResponse.json();
                    console.log(`ä»»åŠ¡è¯¦æƒ…:`, taskData);

                    // æ ¹æ®é”™è¯¯ç±»å‹é€‰æ‹©ä¸€ä¸ªæ¨¡å‹é¢æ¿æ¥æ˜¾ç¤ºé”™è¯¯
                    let provider;
                    switch(errorType) {
                        case 'api_error':
                            provider = 'openai';
                            break;
                        case 'ai_analysis_failed':
                            provider = 'claude';
                            break;
                        case 'code_execution_failed':
                            provider = 'qwen';
                            break;
                        default:
                            provider = 'deepseek';
                    }

                    // æ¨¡æ‹Ÿä»»åŠ¡å¤„ç†å¤±è´¥
                    handleModelError(provider, taskData);
                    
                    alert(`${errorType}é”™è¯¯åœºæ™¯æµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹${provider}æ¨¡å‹é¢æ¿ã€‚`);
                } else {
                    throw new Error('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥');
                }

            } catch (error) {
                console.error(`${errorType}æµ‹è¯•å¤±è´¥:`, error);
                alert(`${errorType}æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }
    </script>
</body>
</html>
